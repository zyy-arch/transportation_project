<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css"/>
    <link href="../ui/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>轨迹回放</title>
    <style>
        html, body, #container {
            height: 100%;
            width: 100%;
        	margin: 0;
        	padding: 0;
        }

        .input-card .btn{
            margin-right: 1.2rem;
            width: 9rem;
        }

        .input-card .btn:last-child{
        margin-right: 0;
    }
    
    .control-panel {
        position: absolute;
        top: 20px;
        left: 20px;
        background: white;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        z-index: 1000;
        width: 320px; /* 固定宽度 */
        max-width: 320px;
    }
    
    .control-panel .form-group {
        margin-bottom: 15px;
    }
    
    .control-panel .btn {
        margin-bottom: 5px;
    }
    
    .control-panel h4 {
        margin-top: 0;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .control-panel hr {
        margin: 15px 0;
    }
    
    /* 确保按钮不会被隐藏 */
    .control-panel input[type="button"] {
        display: block;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* 为按钮添加间距 */
    .control-panel .row {
        margin-left: -5px;
        margin-right: -5px;
    }
    
    .control-panel .col-xs-6 {
        padding-left: 5px;
        padding-right: 5px;
    }
	</style>
</head>
<body>
<div id="container"></div>
<!-- 控制面板 -->
<div class="control-panel">
    <h4>轨迹回放控制</h4>
    
    <!-- 第一行按钮 -->
    <div class="form-group">
        <div class="row">
            <div class="col-xs-6">
                <input type="button" class="btn btn-primary btn-block" value="开始动画" id="start" onclick="startAnimation()"/>
            </div>
            <div class="col-xs-6">
                <input type="button" class="btn btn-secondary btn-block" value="暂停动画" id="pause" onclick="pauseAnimation()"/>
            </div>
        </div>
    </div>
    
    <!-- 第二行按钮 -->
    <div class="form-group">
        <div class="row">
            <div class="col-xs-6">
                <input type="button" class="btn btn-info btn-block" value="继续动画" id="resume" onclick="resumeAnimation()"/>
            </div>
            <div class="col-xs-6">
                <input type="button" class="btn btn-warning btn-block" value="停止动画" id="stop" onclick="stopAnimation()"/>
            </div>
        </div>
    </div>
    
    <hr>
    
    <div class="form-group">
        <label for="originInput">起点坐标</label>
        <input class="form-control" id="originInput" type="text" placeholder="经度,纬度">
    </div>
    <div class="form-group">
        <label for="destinationInput">终点坐标</label>
        <input class="form-control" id="destinationInput" type="text" placeholder="经度,纬度">
    </div>
    <div class="form-group">
        <button class="btn btn-success btn-block" onclick="backGetData()">后端获取模拟</button> 
    	
    	<hr>
    
    	<div class="form-group">
        	<button class="btn btn-success btn-block" onclick="backHomePage()">回到主页</button>
    	</div>
    </div>

<!-- jQuery -->
<script src="../plugins/bower_components/jquery/dist/jquery.min.js"></script>
    <div class="input-item">
        <input type="button" class="btn" value="继续动画" id="resume" onclick="resumeAnimation()"/>
        <input type="button" class="btn" value="停止动画" id="stop" onclick="stopAnimation()"/>
    </div>
</div>
<script type="text/javascript">
  window._AMapSecurityConfig = {
  	securityJsCode: "a30687b5aa11a62810d2e1dabfec39ae",
  }
</script>
<script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=fb938c25f1975ef5cc397e4e9cf63652"></script>
<script>

//全局变量
	var map = new AMap.Map("container", {
    	resizeEnable: true,
    	center: [116.397428, 39.90923],
    	zoom: 17
	});
	var marker = new AMap.Marker({
    	map: map,
    	position: [116.478935,39.997761],
    	icon: "https://a.amap.com/jsapi_demos/static/demo-center-v2/car.png",
    	offset: new AMap.Pixel(-13, -26),
	});
	var polyline = null;
	var passedPolyline = null;
	var currentLineArr = [];
	var animationPluginLoaded = false;

	window.startAnimation = function startAnimation () {
    	if (!animationPluginLoaded) {
        	alert("动画插件尚未加载完成，请稍后再试");
        	return;
    	}
    	if (!currentLineArr || currentLineArr.length === 0) {
        	alert("请先获取路线数据");
        	return;
    	}
    marker.moveAlong(currentLineArr, {
        duration: 10,
        autoRotation: true,
        });
	}
    
		window.pauseAnimation = function () {
        	if (!animationPluginLoaded) {
            	alert("动画插件尚未加载完成");
            	return;
        	}
        	marker.pauseMove();
    	};

    	window.resumeAnimation = function () {
            if (!animationPluginLoaded) {
                alert("动画插件尚未加载完成");
                return;
            }
            marker.resumeMove();
        };

        window.stopAnimation = function () {
            if (!animationPluginLoaded) {
                alert("动画插件尚未加载完成");
                return;
            }
            marker.stopMove();
        };

     // JSAPI2.0 使用覆盖物动画必须先加载动画插件
        AMap.plugin('AMap.MoveAnimation', function(){
            animationPluginLoaded = true; // 标记插件已加载
            console.log("动画插件加载完成");

        window.stopAnimation = function () {
            marker.stopMove();
        };
        
    });
    
    function backGetData () {
    	var origin = $("#originInput").val();
        var destination = $("#destinationInput").val();
    	
    	console.log('按钮交互测试成功');
    	$.ajax({
            url: '../org/getPolyline', // 后端API地址
            type: 'POST', // 请求方式
            data: {
                origin: origin,
                destination: destination
            },
            timeout:30000,
            dataType: 'json', // 预期返回的数据类型
            success: function(response) {
                // 请求成功处理
                if (response.code == 1) {
                    // 成功获取数据，在地图上添加标记
                	console.log('获取数据成功');
                    addRouteAndAnimation(response.polylines);
                    alert('获取数据成功！坐标点数量: ' + response.polylines.length);
                    
                } else {
                    alert('获取数据失败：' + response.message);
                }
            },
            error: function(xhr, status, error) {
                // 请求失败处理
                alert('数据加载失败，请稍后重试');
            }
        });
    }
    
    function addRouteAndAnimation (coordinates) {
		if(!coordinates || coordinates.length === 0){
			console.warn('没有有效的坐标数据');
			return;
		}
		
		currentLineArr = coordinates.map(coord => [coord[0], coord[1]]);
	    console.log('更新路线坐标:', currentLineArr);
	    
	    if (marker) {
	        marker.stopMove();
	    }
	    
	    // 清除之前的路线
	    if (polyline) {
	        polyline.setMap(null);
	    }
	    if (passedPolyline) {
	        passedPolyline.setMap(null);
	    }
	    
	    // 重新创建路线
	    polyline = new AMap.Polyline({
	        map: map,
	        path: currentLineArr,
	        showDir: true,
	        strokeColor: "#28F",
	        strokeWeight: 6,
	    });
	    
	    // 重新创建已通过轨迹
	    passedPolyline = new AMap.Polyline({
	        map: map,
	        strokeColor: "#AF5",
	        strokeWeight: 6,
	    });
	    
	    // 更新标记位置到起点
	    marker.setPosition(currentLineArr[0]);
	    
	    // 重新绑定移动事件
	    marker.on('moving', function (e) {
	        passedPolyline.setPath(e.passedPath);
	        map.setCenter(e.target.getPosition(), true);
	    });
	    
	    // 调整地图视野以适应新路线
	    map.setFitView([polyline]);
	    
	    
    }
    
    function backHomePage () {
    	window.location.href="../org/login";
    }
    
</script>
</body>
</html>